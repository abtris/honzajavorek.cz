<!DOCTYPE html>
<html lang="en">
<head>
        <title>PHP a CLI</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href=".././theme/css/main.css" type="text/css" />
        <link href=".././feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Javorové lístky ATOM Feed" />
        

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href=".././css/ie.css"/>
                <script src=".././js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href=".././css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">

        <header id="banner" class="body">
                <h1><a href="../.">Javorové lístky </a></h1>
                <nav><ul>
                
                    <li><a href="http://www.example.com">Řehoř</a></li>
                
                
                
                
                
                    <li class="active"><a href=".././category/blog.html">blog</a></li>
                
                </ul></nav>
        </header><!-- /#banner -->
                
<section id="content" class="body">    
<article>
        <header> <h1 class="entry-title"><a href=""
        rel="bookmark" title="Permalink to PHP a CLI">PHP a CLI</a></h1>  </header>
        <div class="entry-content">
        <footer class="post-info">
        <abbr class="published" title="2011-01-28T16:46:00">
                28.1.2011
        </abbr>

        
        <address class="vcard author">
                By <a class="url fn" href=".././author/Honza Javorek.html">Honza Javorek</a>
        </address>
        
<p>In <a href=".././category/blog.html">blog</a>. </p>
<p>tags: <a href=".././tag/nette framework.html">nette framework</a><a href=".././tag/php.html">php</a><a href=".././tag/symfony.html">symfony</a></p>


</footer><!-- /.post-info -->
        <p>Ač se to může zdát nezvyklé, PHP je celkem univerzální jazyk a lze
jej samozřejmě
<a href="http://www.php.net/manual/en/features.commandline.php">používat v příkazové řádce operačního systému</a>,
tedy přes CLI. Musíte k tomu mít nainstalované <code>php-cli</code>, což je
zvláštní <code>.deb</code> balíček. Na Windows a jiných systémech nevím. Potom
potřebujete mít samotné PHP v PATH operačního systému. Na Linuxu
byste to tak měli mít už po instalaci (zkuste si do terminálu
napsat <code>$ php</code>, jestli příkaz systém zná), na Windows si musíte do
PATH přidat cestu k <code>php.exe</code>. Potom už můžete radostně spouštět
skripty, třeba <code>php helloworld.php</code>.</p>
<h2>Proč PHP?</h2>
<p>Mohu to přece udělat v Pythonu, BASHi, Perlu, Céčku, … No řekněme,
že to má své výhody. Pokud
<a href="http://php.vrana.cz/php-cli.php">člověk drtivou <strong>většinu života programuje v PHP</strong></a>
a většinu úloh v něm udělá nejrychleji a s největší jistotou, pak
je logické, že si tentýž jazyk vybere i pro skripty ve svém OS nebo
malinké aplikace.</p>
<p>Druhý důvod vidím třeba v tom, že máme webovou aplikaci, která chce
<strong>cronem spouštět nějaké úlohy</strong>. Psát takové úlohy veřejně
přístupné (tzn. že cron vykoná HTTP požadavek na dané URL a tím se
spustí skript) je poměrně nesmysl a psát je v jiném jazyce je
neefektivní – máme-li hotovou aplikaci s připojením k databázi a
propracovaným modelem, je škoda toho rovnou nevyužít a psát to
znova na koleně třeba v Pythonu.</p>
<p>Také se může hodit napsat si jednoduchý skript pro
<strong>automatizaci práce nad určitým projektem</strong>. Já to osobně dělám
často a musím přiznat, že mě to naučil framework
<a href="http://www.symfony-project.org/">Symfony</a>, který má přes příkazy
v CLI automatizováno hodně věcí. Takové skripty často míchám
s BASHem. Skript <code>projekt</code> (vždy použiji název konkrétního
projektu), který mám v PATH a je tedy přístupný odkudkoliv, potom
vypadá třeba takto:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52</pre></div></td><td class="code"><div class="codehilite"><pre><span class="c">#!/bin/bash</span>
<span class="nb">cd</span> ~/workspace/.../projekt/

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$1&quot;</span> <span class="o">=</span> <span class="s2">&quot;ssh&quot;</span> <span class="o">]</span>; <span class="k">then</span>

  <span class="c"># connect to server via ssh</span>
  ssh honzajavorek@225.225.225.225

<span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;$1&quot;</span> <span class="o">=</span> <span class="s2">&quot;cc&quot;</span> <span class="o">]</span>; <span class="k">then</span>

  <span class="c"># clear cache</span>
  rm -rf ./projekt/temp/cache/* ./projekt/temp/sessions/*;
  <span class="nb">exit</span>

<span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;$1&quot;</span> <span class="o">=</span> <span class="s2">&quot;check&quot;</span> <span class="o">]</span>; <span class="k">then</span>

  <span class="c"># check code by Nette Code Checker</span>
  php ./projekt/tools/Code-Checker/code-checker.php -ld ./projekt/
  <span class="nb">exit</span>

<span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;$1&quot;</span> <span class="o">=</span> <span class="s2">&quot;fix&quot;</span> <span class="o">]</span>; <span class="k">then</span>

  <span class="c"># fix code by Nette Code Checker</span>
  php ./projekt/tools/Code-Checker/code-checker.php -fld ./projekt/
  <span class="nb">exit</span>

<span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;$1&quot;</span> <span class="o">=</span> <span class="s2">&quot;git&quot;</span> <span class="o">]</span>; <span class="k">then</span>

<span class="k">  </span><span class="nb">shift </span>1

  <span class="c"># before adding files to git...</span>
  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$1&quot;</span> <span class="o">=</span> <span class="s2">&quot;add&quot;</span> <span class="o">]</span>; <span class="k">then</span>
    <span class="c"># dump database schema into sql file</span>
    ./command schema --dump

    <span class="c"># automatically fix all code</span>
    php ./projekt/tools/Code-Checker/code-checker.php -fld ./projekt/
  <span class="k">fi</span>

  <span class="c"># delegate to git</span>
  git <span class="s2">&quot;$@&quot;</span>
  <span class="nb">exit</span>

<span class="k">else</span>

  <span class="c"># else delegate to CLI interface of my project written in PHP</span>
  ./command <span class="s2">&quot;$@&quot;</span>
  <span class="nb">exit</span>

<span class="k">fi</span>

<span class="nb">echo</span> <span class="s2">&quot;Unknown command.&quot;</span>
</pre></div>
</td></tr></table>

<p>Skript <code>command</code> je ve složce s projektem a vypadá takto:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span class="c">#!/bin/bash</span>
<span class="nv">script_dir</span><span class="o">=</span><span class="sb">`</span>dirname <span class="s2">&quot;$0&quot;</span><span class="sb">`</span>
<span class="nb">exec </span>php <span class="s2">&quot;$script_dir/index.php&quot;</span> <span class="s2">&quot;task:$@&quot;</span>
</pre></div>
</td></tr></table>

<p>Jak vidíte, jen deleguje požadavky na aplikaci. Využívá se zde
<a href="http://forum.nette.org/cs/2015-nette-a-php-cli?pid=13529#p13529">Nette CLI routeru</a>
a jak si můžete všimnout, můj presenter na skriptové požadavky se
nazývá <code>TaskPresenter</code>.</p>
<h2>Specifika CLI</h2>
<p>Při práci s PHP v CLI je třeba myslet na některá jeho <strong>omezení</strong> a
je dobré si uvědomit, čím disponuje navíc. Například nelze
samozřejmě zjistit IP adresu a ani všechny ostatní věci okolo HTTP
požadavku. To je logické, protože žádné HTTP není ve hře, ale vaše
aplikace na tom může záviset. Pro zjištění kde se skript nachází se
mi osvědčila funkce
<a href="http://php.net/manual/en/function.php-uname.php">php_uname</a>,
konkrétně <code>php_uname('n')</code>. Tak snadno poznám, jestli spouštím
skript na mém počítači <em>lisa</em>, nebo na produkčním serveru.</p>
<p>Čím PHP v CLI disponuje navíc? Např. <code>max_execution_time</code> je
<strong>nekonečný</strong>, což je důležité pro dlouhé náročné úlohy. Co je pro
ně ale také důležité je spotřeba paměti. Zapomeňte, že s PHP budete
psát nějaké výkonné skripty – neumí moc paměť uvolňovat a můžete se
snažit jak chcete, ale skript zpracovávající velký objem dat vám
v tomto případě často zhyne na <strong>nedostatek paměti</strong>, ať už mu jí
přidělíte v <code>php.ini</code> kolik chcete. To mě také přivádí k faktu, že
(nevím jak v jiných prostředích, ale na Ubuntu ano) PHP CLI má v
<code>/etc</code> svůj vlastní soubor <code>php.ini</code>, kde můžete mít odlišnou
konfiguraci. Hodí se mít na paměti
<a href="http://www.php.net/manual/en/features.commandline.differences.php">seznam všech nastavení, která jsou v PHP CLI tzv. <em>hardcoded</em></a>.</p>
        </div><!-- /.entry-content -->
        
        <div class="comments">
        <h2>Comments !</h2>
            <div id="disqus_thread"></div>
            <script type="text/javascript">
               var disqus_identifier = "blog/php-a-cli.html";
               (function() {
               var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
               dsq.src = 'http://javorove-listky.disqus.com/embed.js';
               (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
              })();
            </script>
        </div>
        

</article>
</section>

        <section id="extras" class="body">
        
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                        
                            <li><a href="http://docs.notmyidea.org/alexis/pelican/">Pelican</a></li>
                        
                            <li><a href="http://python.org">Python.org</a></li>
                        
                            <li><a href="http://jinja.pocoo.org">Jinja2</a></li>
                        
                            <li><a href="#">You can modify those links in your config file</a></li>
                        
                        </ul>
                </div><!-- /.blogroll -->
        
        
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href=".././feeds/all.atom.xml" rel="alternate">atom feed</a></li>
                            

                        
                            <li><a href="#">You can add links in your config file</a></li>
                        
                        </ul>
                </div><!-- /.social -->
        
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://alexis.notmyidea.org/pelican/">pelican</a>, which takes great advantages of <a href="http://python.org">python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->




<script type="text/javascript">
    var disqus_shortname = 'javorove-listky';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

</body>
</html>